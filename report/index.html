<!DOCTYPE html>
<html>
  <head>
    <title>Laser Display</title>
    <link rel="stylesheet" href="style.css" />
    <script type="text/javascript" src="refs_nums.js"></script>
    <script type="text/javascript">
      function init() {
          match_figure_references();
      }
    </script>
    <script type="text/javascript" async="true"
            src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML">
    </script>
  </head>

  <body onload="init()">
    <header>
      <h1 class="page_title">Laser Display</h1>
      <p>Peter Friend, Istvan Burbank, James Cassell</p>
    </header>

    <section>
      <h2>Introduction</h2>
      <p>
        An image projector that draws using colored lasers controlled by a PIC32.
      </p>

      <p>
        <a href="https://www.youtube.com/watch?v=ttj0Dh9YMYo">Brief video demo</a>, videography by Bruce Land.
      </p>

      <p>
        We use several colored lasers to generate a single pixel.
        A system of mirrors deflects the lasers to control where they shine.
        A vertical mirror controls the height of the projected laser.
        A spinning mirror assembly causes the laser to &quot;scan&quot; horizontally.
        The spinning mirrors always spin at constant speed while the software outputs pixels.
        The vertical mirror changes position at the end of every row.
      </p>
    </section>

    <section>
      <h2>High-level design</h2>
      <p>
        The horizontal mirrors are four mirrors on the sides of a spinning cube.
        A single row of the output display is shown in the time it takes for one of the four spinning mirrors to move through part of it's arc.
        Each rotation of the mirror assembly is thus four rows.
        The rotation of the mirror assembly is used to control the beginning of a row via a phototransistor and Change Notification interrupt.
        DMA outputs the entire row into our diode control circuits, with a timer controlling the time between pixels.
        The interrupt for the end of the DMA block transfer is used to configure the DMA and the vertical mirror for the next row.
      </p>

      <h3>Background math</h3>

      <h3>Logical structure</h3>
      <div class="figure" id="figlogic">
        <img src="logical_structure_diagram.svg" />
        <div class="caption">Logical structure for entire system</div>
      </div>

      <h3>Tradeoffs</h3>

      <h3>Standards and regulations</h3>
      <ul>
        <li>ISO/IEC 9899:1999</li>
        <li>ANSI X3.159-1989</li>
        <li>Public Law 112-95 February 14 2012 112th Congress, Sec 311</li>
      </ul>

      <h3>Intellectual property</h3>
      <ul>
        <li>Protothreads is Copyright 2004-2005, Swedish Institute of Computer Science</li>
        <li>The original TFT library is Copyright (c) 2013 Adafruit Industries</li>
    </section>

    <section>
      <h2>Hardware Design</h2>

    </section>

    <section>
      <h2>Software Design</h2>

      <h3>Framebuffer</h3>
      <p>
        The rows to project are stored in a two-dimensional array of C structs.
        This struct uses bitfields, implementation-specific behavior, and a "bit packing" pragma to ensure that each struct fits in exactly a byte.
        Thus a single byte can be directly copied into the <span class="snippet">PORTB</span> register to output the bits.
        This allows the DMA to transfer draw pixels without software intervention.
        An implementation-defined &quot;struct punning&quot; technique is used to convert these bit-packed structs into a numeric type when they must be written to the port without DMA.
      </p>

      <h3>Projector</h3>
      <p>
        Our projector implementation makes heavy use of hardware timing.
        That is, the projector code consists of several event-driven actions which are triggered by various hardware events.
      </p>
      <p>
        DMA is used to output pixels to the lasers.
        When a horizontal scan line starts, DMA is configured to output the entire row, one pixel per period of timer A.
        Timer A is free running, and its period determines the aspect ratio of the pixels.
        The DMA transfer of the row is enabled by a Change Notification ISR which runs when the optical transistor is triggered.
        We configured the Change Notification via registers directly because our version of plib is missing the macros.
        Because this PIC32 cannot distinguish between rising and falling edges when triggering the Change Notification ISR, we simply check the value of the pin in software.
        Thus, effectively, the rising edge of the optical transistor triggers the start of a row being output.
        Because the optical transistor is driven by the spinning mirror carousel, the timing of the rows is too so spinning the carousel faster would result in faster output of rows.
      </p>

      <p>
        When a row finishes the DMA triggers an interrupt that increments the Y-axis mirror's position.
        The reason it is done immediately at the end of a line is to ensure the mirror has time to settle into its new position before the start of the next row.
        The mirror is incremented linearly on each row until it reaches the bottom of the frame then it wraps around again to the top.
        Because the increment is triggered by the DMA which is triggered the spinning carousel, spinning the carousel faster would cause the Y-axis mirror's scan rate to increase.
      </p>
      <p>
        The last two paragraphs made claims about the timing of the projector with respect to the carousel.
        In fact, spinning the carousel faster would increase the frame rate without any software changes.
        As the software stands now, the aspect ratio would change but that could be configured out (as the mirror spins faster the rows would get wider).
        The aspect ratio is determined by the period of the timer that triggers cell transfers in the DMA.
      </p>

      <h4>Failed attempt to use one fewer ISR</h4>
      <p>
        An earlier design attempted to use the gated mode of Timer1 to control the DMA and avoid the Change Notification ISR.
        The idea was that each timer period would start a cell transfer, but the timer would only run when a row had to be output.
        The edge caused by the phototransistor circuit was used to asynchronously set an external flip-flop high and the flip-flop output was used as the gate signal.
        The flip-flop would be asynchronously set low in the end of row ISR before the DMA was configured for the next row.
        This would have meant that an ISR was not required at the beginning of the row, only at the end.
        We abandoned this because the non-obvious but documented behavior of gated timers is to generate an interrupt when the gate input goes low and deactivates the timer, rather than on period match.
        This caused the DMA cell transfers to never fire.
      </p>

      <h3>Rendering library</h3>
      <p>
        We ported the TFT drawing library to be backed by our framebuffer rather than by the TFT.
        Due to the simplicity of the framebuffer interface, only <span class="snippet">rendering_drawPixel</span> in the ported library had to be aware of the framebuffer.
        However, a number of functions in the interface to the original TFT library were written in a way that was tied to the TFT hardware, presumably for efficiency reasons.
        We rewrote these functions in terms of <span class="snippet">rendering_drawPixel</span> to minimize dependence between the projector and the rendering library.
        This payed off when slightly changing the projector interface midway through the project required minimal changes to the rendering library.
        Additionally, the color representation of the original TFT library had to be replaced with our color struct, requiring very minor changes throughout the entire library.
        We added morse code drawing functions to the rendering library as a demonstration.
        All of the graphics in the demo are drawn using this library.
      </p>

      <p>

    </section>

    <section>
      <h2>Results</h2>
      <div class="figure" id="figinterleaveddots">
        <img src="images/interleaved_dots.jpg" />
        <div class="caption">Projecting Interleaved Dots</div>
      </div>

      <p>
        We started the project unsure if we would be able to achieve nothing or full VGA resolution projection.
        When we demoed the project we were able to display very crude 7x200 pixel frames with the red and blue lasers each with four different intensities (pictured above).
        In the next three sections we discuss what we were able to achieve more specifically in terms of quantitative results, safety, and usability.
      </p>

      <h3>Operation</h3>
      <p>
        The projector operates sufficiently to display up to ten rows at 10 FPS, and we have tested up to 200 columns successfully.
        We are able to project red and blue with variable intensities.
        Below is a brief analysis of the performance of each component of the projector.
      </p>

      <p>
        The mirror carousel is a 3D printed cube with four mirrors attached to it, and that spins at over 1000 RPM.
        The limiting factor on our design was the mirror carousel.
        The timing of the whole projection system is based on the period of the mirrors spinning;
        if the mirrors spin faster then the FPS increases.
        Our mirror assembly is quite large, powered by a weak motor, and is not perfectly aligned.
        The result is that the mirrors spin slowly (at just over 1000 RPM), causing low FPS, and are off center causing the scan lines to be slightly unevenly spaced.
        The carousel spins at approximately 1200 RPM with is effectively 4800 RPM due to the four mirrors.
        If we were to drop in a faster effective carousel then the framerate would increase with no additional changes and would give us more headroom to project more rows.
      </p>

      <p>
        The Y-axis mirror performs very well.
        The mirror is commanded to a new position at the end of each row and by visual inspection of the next projected row we can demonstrate that the mirror has settled by the time the next row starts.
        The mirror's position is precisely control-able allowing us to fine tune the spacing between rows.
        The galvanometer to which the mirror is attached draws 800 mAmps during normal operating (having a50 Ohm real component to its impedance).
        The high current draw necessitated a large amplifier which also serves to quickly control the voltage to the mirror.
        In total, the mirror setup is relatively simple and very effective.
      </p>

      <p>
        The lasers and supporting circuitry successfully provide four-intensity control over red and blue lasers.
        The green laser circuitry is functional but we did not have a green laser which with to demo.
        The lasers are able switch on and off fast enough to project reasonably sized pixels and can produce sufficient intensities.
      </p>

      <p>
        In total, the system functions acceptably well with a few clear and solvable bottlenecks which we plan to address in the future.
      </p>

      <h3>Safety</h3>
      The use of lasers and the exposed, spinning mirror carousel are the primary concerns in terms of safety.
      To help control the dangerous regions where the lasers may be shining we employed cardboard guarding and operated in an unoccupied part of the room.
      After sufficient testing and tuning we were able to decrease the region in which the lasers would likely shine making safe operation easier.
      The spinning mirror carousel, operating at over 1000 RPM and with sharp corners, proved a minor hazard and one with was easy to identify (it is both noisy and visually easy to determine to be spinning) and easy to avoid.
      Overall, the risk when using the projector is minimal with trivial effort to avoid hazards.

      <h3>Usability</h3>
      We will comment on two types of usability: the usability from perspective of controlling what is projected and from the perspective of operating the device.
      We ported the tft drawing library used earlier in the class to our projector meaning it is not difficult for someone with training comparable to students received in the class to use the projector from a projection perspective.
      Currently, the program needs to be compiled and written to the microcontroller before use which proves to be a barrier for some users as compared to a VGA or HDMI connection.
      The usability of the device presupposing the software has been prepared and loaded is relatively trivial: there are three sources of power that need to be connected (power over usb, an inverter that plugs into the wall, and a 3.3V bench top supply).
      Besides powering the device there is occasionally a need to calibrate the position of the lasers, but that is rare.

      The device as it stands is clearly a prototype.
      A better packaged model would eliminate these needs and simplify operation to a single power connection and a standard interface to control the projection.
      We plan to make such modifications on our own and as part of future classes.

    </section>

    <section>
      <h2>Conclusions</h2>

    </section>

    <section>
      <h2>Appendix A</h2>
      <p>
        The group approves this report for inclusion on the course website.
      </p>

      <p>
        The group approves <a href="https://www.youtube.com/watch?v=ttj0Dh9YMYo">the video</a> for inclusion on the course youtube channel.
      </p>
    </section>

    <section>
      <h2>Appendix: Code listing</h2>

    </section>

    <section>
      <h2>Appendix: Schematics</h2>
      <div class="figure" id="figschmatic">
        <img src="images/circuit_sch.png" />
        <div class="caption">Circuit Schematic</div>
      </div>

    </section>

    <section>
      <h2>Appendix: Cost and parts list</h2>

    </section>

    <section>
      <h2>Appendix: Work division</h2>

    </section>

    <section>
      <h2>Appendix: References</h2>
      <h3>Data sheets</h3>

      <h3>Vendor sites</h3>

      <h3>Borrowed designs</h3>

      <h3>Background</h3>

    </section>
  </body>
</html>
